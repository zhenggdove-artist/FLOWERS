<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>æ®–æ°‘ä¹‹èŠ± AR</title>
	<style>
		body {
			margin: 0;
			padding: 0;
			background: #000;
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			height: 100vh;
			font-family: Arial, sans-serif;
			overflow: hidden;
			position: fixed;
			width: 100%;
		}

		/* ç›¸æ©Ÿ video - å…¨è¢å¹• */
		#video {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			object-fit: cover;
			z-index: 1;
		}

		/* åŠé€æ˜åƒè€ƒåœ–ç‰‡ - å¼•å°å±¤ */
		#referenceImage {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			object-fit: contain;
			z-index: 5;
			opacity: 0.3;
			pointer-events: none;
			display: none;
			background-position: center;
			background-repeat: no-repeat;
			background-size: contain;
		}

		#referenceImage.active {
			display: block;
		}

		/* Canvas å‰æ™¯ - ç¹ªè£½èŠ±æœµ */
		#canvas {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: 10;
			pointer-events: none;
		}

		/* å•Ÿå‹•æŒ‰éˆ• */
		button {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			margin: 0;
			padding: 30px 70px;
			font-size: 28px;
			font-weight: bold;
			background: white;
			color: #667eea;
			border: none;
			border-radius: 50px;
			cursor: pointer;
			z-index: 1000;
			box-shadow: 0 10px 40px rgba(0,0,0,0.4);
		}

		button:active {
			background: #f0f0f0;
		}

		button.hidden {
			display: none;
		}

		/* å•Ÿå‹•ç•«é¢èƒŒæ™¯ */
		#startBg {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			z-index: 999;
		}

		#startBg.hidden {
			display: none;
		}

		/* æ¨™é¡Œ */
		.title {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -200%);
			color: white;
			font-size: 48px;
			font-weight: bold;
			z-index: 1001;
			text-shadow: 0 4px 15px rgba(0,0,0,0.3);
		}

		.title.hidden {
			display: none;
		}

		/* æ‹ç…§æŒ‰éˆ• */
		#captureBtn {
			position: fixed;
			bottom: 50px;
			left: 50%;
			transform: translateX(-50%);
			width: 90px;
			height: 90px;
			border-radius: 50%;
			background: white;
			border: 7px solid rgba(255,255,255,0.6);
			box-shadow: 0 0 0 5px rgba(0,0,0,0.3), 0 10px 35px rgba(0,0,0,0.6);
			font-size: 45px;
			cursor: pointer;
			z-index: 20;
			display: none;
			align-items: center;
			justify-content: center;
			padding: 0;
			margin: 0;
		}

		#captureBtn.active {
			display: flex;
		}

		#captureBtn:active {
			transform: translateX(-50%) scale(0.9);
		}

		/* é ‚éƒ¨æ¨™é¡Œ */
		#topTitle {
			position: fixed;
			top: 50px;
			left: 50%;
			transform: translateX(-50%);
			color: white;
			font-size: 24px;
			font-weight: bold;
			text-shadow: 0 3px 12px rgba(0,0,0,0.9);
			background: rgba(0,0,0,0.5);
			padding: 12px 25px;
			border-radius: 25px;
			backdrop-filter: blur(15px);
			-webkit-backdrop-filter: blur(15px);
			z-index: 20;
			display: none;
			text-align: center;
		}

		#topTitle.active {
			display: block;
		}

		/* åˆ‡æ›åƒè€ƒåœ–æŒ‰éˆ• */
		#toggleRef {
			position: fixed;
			top: 120px;
			right: 20px;
			background: rgba(255,255,255,0.25);
			color: white;
			border: 2px solid rgba(255,255,255,0.5);
			border-radius: 20px;
			padding: 10px 18px;
			font-size: 14px;
			z-index: 20;
			display: none;
			backdrop-filter: blur(10px);
			-webkit-backdrop-filter: blur(10px);
			cursor: pointer;
		}

		#toggleRef.active {
			display: block;
		}

		#status {
			color: white;
			margin: 10px;
			text-align: center;
			position: fixed;
			bottom: 20px;
			left: 50%;
			transform: translateX(-50%);
			z-index: 999;
			background: rgba(0,0,0,0.7);
			padding: 10px 20px;
			border-radius: 20px;
			font-size: 16px;
		}
	</style>
</head>
<body>
	<!-- å•Ÿå‹•èƒŒæ™¯ -->
	<div id="startBg"></div>

	<!-- å•Ÿå‹•æ¨™é¡Œ -->
	<div class="title">ğŸŒ¸ æ®–æ°‘ä¹‹èŠ±</div>

	<!-- ç‹€æ…‹è¨Šæ¯ -->
	<div id="status">é»æ“ŠæŒ‰éˆ•å•Ÿå‹•ç›¸æ©Ÿ</div>

	<!-- å•Ÿå‹•æŒ‰éˆ• -->
	<button id="start">é–‹å§‹é«”é©—</button>

	<!-- ç›¸æ©Ÿ video -->
	<video id="video" autoplay playsinline muted></video>

	<!-- åŠé€æ˜åƒè€ƒåœ–ç‰‡ -->
	<div id="referenceImage"></div>

	<!-- Canvas å‰æ™¯ -->
	<canvas id="canvas"></canvas>

	<!-- é ‚éƒ¨æ¨™é¡Œ -->
	<div id="topTitle">ğŸŒ¸ å°é½Šå ´æ™¯å¾Œæ‹ç…§<br><small style="font-size:14px; opacity:0.8;">èŠ±æœµæœƒç”Ÿæˆåœ¨å›ºå®šä½ç½®</small></div>

	<!-- åˆ‡æ›åƒè€ƒåœ–æŒ‰éˆ• -->
	<button id="toggleRef">ğŸ‘ï¸ åƒè€ƒåœ–</button>

	<!-- æ‹ç…§æŒ‰éˆ• -->
	<button id="captureBtn">ğŸ“·</button>

	<script>
		const video = document.getElementById('video');
		const button = document.getElementById('start');
		const status = document.getElementById('status');
		const canvas = document.getElementById('canvas');
		const ctx = canvas.getContext('2d');
		const startBg = document.getElementById('startBg');
		const titleEl = document.querySelector('.title');
		const captureBtn = document.getElementById('captureBtn');
		const topTitle = document.getElementById('topTitle');
		const referenceImg = document.getElementById('referenceImage');
		const toggleRefBtn = document.getElementById('toggleRef');

		let flowers = [];
		let animationRunning = false;
		let showReference = true;

		// ============================================
		// èŠ±æœµç”Ÿæˆä½ç½®è¨­å®šï¼ˆç›¸å°æ–¼ç•«é¢çš„ç™¾åˆ†æ¯”ï¼‰
		// æ ¹æ“šä½ çš„åƒè€ƒç…§ç‰‡èª¿æ•´é€™äº›ä½ç½®
		// ============================================
		const flowerSpots = [
			// æ ¼å¼ï¼š{ x: æ°´å¹³(0-1), y: å‚ç›´(0-1), name: 'ä½ç½®åç¨±' }
			{ x: 0.35, y: 0.65, name: 'æ¤…å­å·¦å´' },
			{ x: 0.55, y: 0.62, name: 'æ¤…å­ä¸Š' },
			{ x: 0.45, y: 0.75, name: 'æ¤…å­å‰æ–¹åœ°æ¿' },
			{ x: 0.72, y: 0.68, name: 'æ¡Œå­æ—' },
			{ x: 0.25, y: 0.55, name: 'ç‰†å£ç•«ä½œä¸‹æ–¹' },
			{ x: 0.8, y: 0.55, name: 'çª—æˆ¶æ—' },
			{ x: 0.5, y: 0.8, name: 'åœ°æ¿ä¸­å¤®' },
			{ x: 0.65, y: 0.58, name: 'æ¤…èƒŒä¸Š' },
		];

		let currentSpotIndex = 0;

		// Canvas å°ºå¯¸
		function resizeCanvas() {
			canvas.width = window.innerWidth;
			canvas.height = window.innerHeight;
		}
		window.addEventListener('resize', resizeCanvas);
		resizeCanvas();

		// ============================================
		// è¨­å®šåƒè€ƒåœ–ç‰‡
		// ä½ å¯ä»¥ç”¨ä»¥ä¸‹ä¸‰ç¨®æ–¹å¼ï¼š
		// ============================================

		// æ–¹å¼ 1ï¼šä½¿ç”¨ä½ æ‹çš„ç…§ç‰‡ï¼ˆéœ€è¦ä¸Šå‚³åˆ°ç¶²è·¯ï¼‰
		// referenceImg.style.backgroundImage = 'url(ä½ çš„åœ–ç‰‡ç¶²å€.jpg)';

		// æ–¹å¼ 2ï¼šä½¿ç”¨åŠé€æ˜ç¶²æ ¼ä½œç‚ºç¤ºæ„ï¼ˆç›®å‰ä½¿ç”¨ï¼‰
		referenceImg.style.background = `
			repeating-linear-gradient(
				0deg,
				rgba(255,255,255,0.08) 0px,
				rgba(255,255,255,0.08) 1px,
				transparent 1px,
				transparent 40px
			),
			repeating-linear-gradient(
				90deg,
				rgba(255,255,255,0.08) 0px,
				rgba(255,255,255,0.08) 1px,
				transparent 1px,
				transparent 40px
			)
		`;

		// æ–¹å¼ 3ï¼šä½¿ç”¨ base64 å…§åµŒåœ–ç‰‡ï¼ˆå°‡åœ–ç‰‡è½‰æ›å¾Œè²¼åœ¨é€™è£¡ï¼‰
		// referenceImg.style.backgroundImage = 'url(data:image/jpeg;base64,...)';

		// ç¹ªè£½èŠ±æœµ
		function draw() {
			if (!animationRunning) return;

			ctx.clearRect(0, 0, canvas.width, canvas.height);

			// ç¹ªè£½æ‰€æœ‰èŠ±æœµ
			flowers.forEach(f => {
				const s = 80 * f.scale;
				ctx.save();
				ctx.globalAlpha = f.alpha;
				ctx.shadowColor = 'rgba(0,0,0,0.6)';
				ctx.shadowBlur = 20;
				ctx.shadowOffsetY = 10;

				ctx.fillStyle = f.color;
				ctx.fillRect(f.x - s/2, f.y - s/2, s, s);

				ctx.shadowBlur = 0;
				ctx.strokeStyle = 'white';
				ctx.lineWidth = 5;
				ctx.strokeRect(f.x - s/2, f.y - s/2, s, s);

				ctx.fillStyle = 'white';
				ctx.beginPath();
				ctx.arc(f.x, f.y, 7, 0, Math.PI * 2);
				ctx.fill();

				ctx.restore();

				if (f.scale < 1) f.scale += 0.06;
				if (f.alpha < 1) f.alpha += 0.06;
			});

			requestAnimationFrame(draw);
		}

		// å•Ÿå‹•ç›¸æ©Ÿ - ä½¿ç”¨ test_camera.html çš„æˆåŠŸé‚è¼¯
		button.addEventListener('click', async () => {
			status.textContent = 'æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...';

			try {
				const stream = await navigator.mediaDevices.getUserMedia({
					video: { facingMode: 'environment' }
				});

				video.srcObject = stream;
				await video.play();

				status.textContent = 'âœ… ç›¸æ©Ÿå•Ÿå‹•æˆåŠŸï¼';
				button.classList.add('hidden');
				startBg.classList.add('hidden');
				titleEl.classList.add('hidden');

				// é¡¯ç¤º UI
				captureBtn.classList.add('active');
				topTitle.classList.add('active');
				referenceImg.classList.add('active');
				toggleRefBtn.classList.add('active');

				// é–‹å§‹ç¹ªè£½
				animationRunning = true;
				draw();

				setTimeout(() => {
					status.style.display = 'none';
				}, 2000);

			} catch (error) {
				status.textContent = 'âŒ éŒ¯èª¤ï¼š' + error.message;
				console.error(error);
			}
		});

		// åˆ‡æ›åƒè€ƒåœ–é¡¯ç¤º/éš±è—
		toggleRefBtn.addEventListener('click', () => {
			showReference = !showReference;
			referenceImg.style.opacity = showReference ? '0.3' : '0';
			toggleRefBtn.textContent = showReference ? 'ğŸ‘ï¸ åƒè€ƒåœ–' : 'ğŸ‘ï¸â€ğŸ—¨ï¸ åƒè€ƒåœ–';
		});

		// æ‹ç…§ - åœ¨å›ºå®šä½ç½®ç”ŸæˆèŠ±æœµï¼ˆä¸è·Ÿéš¨é»ƒè‰²åå­—ï¼‰
		captureBtn.addEventListener('click', () => {
			// å–å¾—ç•¶å‰ç”Ÿæˆä½ç½®
			const spot = flowerSpots[currentSpotIndex % flowerSpots.length];

			// è¨ˆç®—å¯¦éš›åƒç´ ä½ç½®
			const x = canvas.width * spot.x;
			const y = canvas.height * spot.y;

			// éš¨æ©Ÿé¡è‰²
			const colors = [
				'rgba(255,100,150,0.9)',
				'rgba(150,100,255,0.9)',
				'rgba(100,200,255,0.9)',
				'rgba(255,200,100,0.9)',
				'rgba(100,255,150,0.9)',
				'rgba(255,255,100,0.9)'
			];

			// å»ºç«‹èŠ±æœµ
			flowers.push({
				x: x,
				y: y,
				color: colors[Math.floor(Math.random() * colors.length)],
				scale: 0.3,
				alpha: 0,
				spot: spot.name
			});

			// ç§»åˆ°ä¸‹ä¸€å€‹ä½ç½®
			currentSpotIndex++;

			// é–ƒå…‰æ•ˆæœ
			const flash = document.createElement('div');
			flash.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:white;z-index:100;pointer-events:none;opacity:0.95;';
			document.body.appendChild(flash);
			setTimeout(() => {
				flash.style.transition = 'opacity 0.5s';
				flash.style.opacity = '0';
				setTimeout(() => flash.remove(), 500);
			}, 100);

			// æç¤ºè¨Šæ¯
			const msg = document.createElement('div');
			msg.style.cssText = `
				position: fixed;
				top: 150px;
				left: 50%;
				transform: translateX(-50%);
				background: rgba(0,0,0,0.85);
				color: white;
				padding: 15px 30px;
				border-radius: 25px;
				z-index: 30;
				font-size: 18px;
				box-shadow: 0 5px 20px rgba(0,0,0,0.5);
			`;
			msg.textContent = `âœ¨ ${spot.name}`;
			document.body.appendChild(msg);
			setTimeout(() => {
				msg.style.transition = 'opacity 0.5s';
				msg.style.opacity = '0';
				setTimeout(() => msg.remove(), 500);
			}, 1500);

			console.log('ğŸŒ¸ èŠ±æœµç”Ÿæˆ:', spot.name, 'ç¸½æ•¸:', flowers.length);
		});
	</script>
</body>
</html>
